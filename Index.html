<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LockGram Mini</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <style>
    :root{--accent:#00ff88;--bg:#0a0a0a;--card:#111;--text:#fff;--sub:#aaa}
    *{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif}
    body{background:var(--bg);color:var(--text);display:flex;flex-direction:column;align-items:center;padding:20px;min-height:100vh}
    header{text-align:center;margin-bottom:30px}
    header img{height:60px;border-radius:50%}
    header h1{font-size:24px;color:var(--accent);margin-top:8px}
    header p{color:var(--sub);font-size:14px}
    #wallet{width:100%;max-width:320px;margin-bottom:20px}
    #connectContainer{width:100%;margin-top:10px}
    #actions{display:flex;flex-direction:column;gap:12px;width:100%;max-width:320px}
    .btn{background:var(--accent);color:#000;border:none;padding:14px;border-radius:24px;font-weight:700;cursor:pointer;transition:.2s;font-size:16px;width:100%}
    .btn:hover{transform:scale(1.03)}
    footer{margin-top:auto;text-align:center;font-size:14px;color:var(--sub);padding:20px 0}
    footer span{color:var(--accent);font-weight:700;font-size:18px}
    #addr{margin-top:8px;font-size:13px;color:var(--sub);word-break:break-all}
    #status{margin-top:15px;color:var(--accent);font-weight:600}
  </style>
</head>
<body>
  <header>
    <img src="https://i.imgur.com/LQuakpq.png" alt="LockGram"/>
    <h1>LockGram Mini</h1>
    <p>Connect TON wallet ‚Üí earn LockCoins</p>
  </header>

  <section id="wallet">
    <div id="connectContainer"></div>
    <p id="addr"></p>
  </section>

  <section id="actions">
    <button class="btn" onclick="invite()">Invite Friend (+10 LC)</button>
    <button class="btn" onclick="checkIn()">Daily Check-In (+5 LC)</button>
  </section>

  <footer>
    <p>Balance: <span id="balance">0</span> LockCoins</p>
    <p id="status">Tap Connect to start</p>
  </footer>

  <script>
    Telegram.WebApp.ready();
    Telegram.WebApp.expand();

    let userBalance = 0;
    let userWallet = null;
    let tonConnectUI = null;

    // Wait for TON Connect script to load, then init
    function initTonConnect() {
      if (typeof TON_CONNECT_UI === 'undefined') {
        console.error('TON Connect UI not loaded yet');
        setTimeout(initTonConnect, 500); // Retry
        return;
      }

      try {
        tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
          manifestUrl: 'https://meek-creponne-1338a7.netlify.app/manifest.json',
          buttonRootId: 'connectContainer'
        });
        console.log('TON Connect UI initialized successfully');

        // Listen for wallet changes
        tonConnectUI.onStatusChange((wallet) => {
          console.log('Wallet status changed:', wallet ? 'connected' : 'disconnected');
          userWallet = wallet;
          const addrEl = document.getElementById('addr');
          const statusEl = document.getElementById('status');

          if (wallet) {
            const short = wallet.account.address.slice(0, 6) + '...' + wallet.account.address.slice(-4);
            addrEl.textContent = short;
            statusEl.textContent = 'Wallet connected!';

            // First-time bonus
            if (!localStorage.getItem('lockgram_first_connect')) {
              addCoins(50);
              localStorage.setItem('lockgram_first_connect', 'true');
            }
          } else {
            addrEl.textContent = '';
            statusEl.textContent = 'Connect your wallet';
          }
        });

        // Trigger initial status check
        tonConnectUI.onStatusChange(tonConnectUI.connected);
      } catch (error) {
        console.error('Failed to init TON Connect UI:', error);
        document.getElementById('status').textContent = 'Error loading wallet connector ‚Äì check console';
      }
    }

    // Start init after DOM loads
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTonConnect);
    } else {
      initTonConnect();
    }

    // Add coins + haptic + save
    function addCoins(amount) {
      userBalance += amount;
      document.getElementById('balance').textContent = userBalance;
      localStorage.setItem('lockgram_balance', userBalance.toString());
      if (Telegram.WebApp.HapticFeedback) {
        Telegram.WebApp.HapticFeedback.impactOccurred('medium');
      }
      Telegram.WebApp.showAlert(`+${amount} LockCoins! üéâ`);
    }

    // Load balance on start
    const savedBalance = localStorage.getItem('lockgram_balance');
    if (savedBalance) {
      userBalance = parseInt(savedBalance, 10);
      document.getElementById('balance').textContent = userBalance;
    }

    // Invite
    function invite() {
      if (!userWallet) {
        Telegram.WebApp.showAlert('Connect wallet first, bro!');
        return;
      }
      const ref = userWallet.account.address.slice(-8);
      const url = `https://t.me/Lockgramapp_bot/Lockgrammini?startapp=ref_${ref}`;
      Telegram.WebApp.openLink(url);
      addCoins(10);
      document.getElementById('status').textContent = 'Invite sent! +10 LC';
    }

    // Check-in
    function checkIn() {
      const today = new Date().toDateString();
      if (localStorage.getItem('lockgram_checkin') === today) {
        Telegram.WebApp.showAlert('Already checked in today! Tomorrow? ‚è∞');
        return;
      }
      localStorage.setItem('lockgram_checkin', today);
      addCoins(5);
      document.getElementById('status').textContent = 'Daily check-in! +5 LC';
    }
  </script>
</body>
</html>
