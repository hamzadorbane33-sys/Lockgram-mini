<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LockGram Mini</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <style>
    :root{--a:#00ff88;--bg:#0a0a0a;--c:#111;--t:#fff;--s:#aaa;--p:#ff00aa;--r:#ff0055}
    *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,sans-serif}
    body{background:var(--bg);color:var(--t);min-height:100vh;display:flex;flex-direction:column}
    header{text-align:center;padding:20px 0;background:#111;position:sticky;top:0;z-index:10;border-bottom:2px solid var(--a)}
    header img{height:60px;border-radius:50%;border:3px solid var(--a)}
    header h1{font-size:24px;color:var(--a);margin:8px 0 4px;font-weight:900}
    .tabs{display:flex;background:#111;border-bottom:1px solid #333;position:sticky;top:88px;z-index:9}
    .tab{padding:14px;flex:1;text-align:center;font-weight:700;cursor:pointer;transition:.2s}
    .tab.active{background:var(--a);color:#000}
    .content{padding:15px;display:none}
    .content.active{display:block}
    .locked{background:#220011;padding:40px 20px;text-align:center;border-radius:16px;margin:20px 0}
    .locked h2{color:var(--r);font-size:22px;margin:15px 0}
    .locked p{color:var(--s)}
    #connectContainer{margin:15px 0}
    #addr{font-size:13px;color:var(--s);margin:10px 0;word-break:break-all}
    .btn{background:var(--a);color:#000;border:none;padding:16px;border-radius:28px;font-weight:800;font-size:17px;width:100%;margin:10px 0;cursor:pointer}
    #balance{font-size:36px;color:var(--a);font-weight:900}
    #timer{margin:10px 0 20px;color:var(--p);font-size:18px;font-weight:600}
    #messages,#feed{max-height:60vh;overflow-y:auto;padding:10px;background:#111;border-radius:16px}
    .msg{padding:10px;border-radius:12px;margin:8px 0;background:#1a1a1a;position:relative}
    .msg-name{font-weight:700;font-size:13px;color:var(--a)}
    .msg-text{margin-top:4px;word-break:break-all}
    .msg-time{font-size:11px;color:#666;float:right}
    #chatInput,#postInput{width:100%;padding:14px;background:#222;border:none;border-radius:50px;color:white;margin:10px 0}
    #sendBtn,#postBtn{background:var(--a);color:#000;border:none;padding:14px 20px;border-radius:50px;font-weight:800;cursor:pointer}
    footer{padding:15px;text-align:center;color:var(--s);font-size:13px}
  </style>
</head>
<body>
  <header>
    <img src="https://i.imgur.com/LQuakpq.png" alt="LockGram">
    <h1>LockGram Mini</h1>
    <p>Balance: <span id="balance">0</span> LC</p>
    <p id="timer">Connect wallet to farm</p>
  </header>

  <div class="tabs">
    <div class="tab active" onclick="openTab('farm')">Farm</div>
    <div class="tab" onclick="checkWallet('chat')">Chat</div>
    <div class="tab" onclick="checkWallet('journey')">Journey</div>
  </div>

  <!-- FARM -->
  <div id="farm" class="content active">
    <div id="connectContainer"></div>
    <p id="addr"></p>
    <p id="status" style="color:var(--a);margin:15px 0">Connect wallet = +50 LC bonus</p>
    <button class="btn" onclick="invite()">Invite Friend (+10 LC)</button>
    <button class="btn" onclick="checkIn()">Daily Check-In (+5 LC)</button>
  </div>

  <!-- CHAT (locked until wallet) -->
  <div id="chat" class="content">
    <div id="chatLocked" class="locked">
      <h2>Wallet Required</h2>
      <p>You must connect your TON wallet to chat</p>
    </div>
    <div id="chatUnlocked" style="display:none">
      <div id="messages"></div>
      <input type="text" id="chatInput" placeholder="Say something..." maxlength="200">
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <!-- JOURNEY (locked until wallet) -->
  <div id="journey" class="content">
    <div id="journeyLocked" class="locked">
      <h2>Wallet Required</h2>
      <p>Connect wallet to share your journey</p>
    </div>
    <div id="journeyUnlocked" style="display:none">
      <div id="feed"></div>
      <textarea id="postInput" placeholder="Share your farming journey..." maxlength="300" rows="3"></textarea>
      <button id="postBtn">Post Journey</button>
    </div>
  </div>

  <footer>Only real farmers chat here • Connect wallet now</footer>

  <script>
    Telegram.WebApp.ready(); Telegram.WebApp.expand();
    const user = Telegram.WebApp.initDataUnsafe.user || {};
    let balance = 0, wallet = null, tonConnectUI = null, farming = null;

    balance = parseInt(localStorage.getItem('lockgram_balance') || '0');
    document.getElementById('balance').textContent = balance;

    // TON Connect
    function initTC() {
      if (!window.TON_CONNECT_UI) return setTimeout(initTC, 300);
      tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
        manifestUrl: 'https://meek-creponne-1338a7.netlify.app/manifest.json',
        buttonRootId: 'connectContainer'
      });
      tonConnectUI.onStatusChange(w => {
        wallet = w;
        if (w) {
          document.getElementById('addr').textContent = w.account.address.slice(0,6)+'...'+w.account.address.slice(-4);
          document.getElementById('status').textContent = 'Farming +1 LC/min';
          if (!localStorage.getItem('first_connect')) { addCoins(50); localStorage.setItem('first_connect','1'); }
          startFarming();
          unlockSocial(); // <— THIS UNLOCKS CHAT & JOURNEY
        }
      });
    }
    initTC();

    // Unlock chat & journey when wallet connects
    function unlockSocial() {
      document.getElementById('chatLocked').style.display = 'none';
      document.getElementById('chatUnlocked').style.display = 'block';
      document.getElementById('journeyLocked').style.display = 'none';
      document.getElementById('journeyUnlocked').style.display = 'block';
      loadMessages();
    }

    function Farming() {
      if (farming) return;
      farming = setInterval(() => {
        if (document.visibilityState === 'visible' && wallet) {
          addCoins(1);
          document.getElementById('timer').textContent = 'Farming live +1 LC/min';
        }
      }, 60000);
    }
    function stopFarming() { clearInterval(farming); farming = null; }

    function addCoins(n) {
      balance += n;
      document.getElementById('balance').textContent = balance;
      localStorage.setItem('lockgram_balance', balance);
      Telegram.WebApp.HapticFeedback.impactOccurred('medium');
      if (n>1) postAuto(`just farmed +\( {n} LC! Total: \){balance} LC`);
    }

    // Block tab switch if no wallet
    function checkWallet(tab) {
      if (!wallet) {
        Telegram.WebApp.showAlert('Connect your TON wallet first to join the community!');
        return;
      }
      openTab(tab);
    }

    function openTab(name) {
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
      document.querySelector(`.tab[onclick="checkWallet('${name}')"]`)?.classList.add('active') || 
      document.querySelector(`.tab[onclick="openTab('${name}')"]`).classList.add('active');
      document.getElementById(name).classList.add('active');
      if ((name === 'chat' || name === 'journey') && wallet) loadMessages();
    }

    // Chat & Feed (same as before)
    function saveMessage(type, text) {
      const msgs = JSON.parse(localStorage.getItem('lockgram_messages') || '[]');
      msgs.push({
        id: Date.now(),
        type,
        name: user.first_name || 'Farmer',
        username: user.username ? '@'+user.username : '',
        text,
        time: new Date().toLocaleTimeString([], {hour:'
