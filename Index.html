                <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LockGram Mini</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
  <style>
    :root{--a:#00ff88;--bg:#0a0a0a;--c:#111;--t:#fff;--s:#aaa;--p:#ff00aa}
    *{margin:0;padding:0;box-sizing:border-box;font-family:system-ui,sans-serif}
    body{background:var(--bg);color:var(--t);min-height:100vh;display:flex;flex-direction:column}
    header{text-align:center;padding:20px 0;background:#111;position:sticky;top:0;z-index:10;border-bottom:2px solid var(--a)}
    header img{height:60px;border-radius:50%;border:3px solid var(--a)}
    header h1{font-size:24px;color:var(--a);margin:8px 0 4px;font-weight:900}
    .tabs{display:flex;background:#111;border-bottom:1px solid #333;position:sticky;top:88px;z-index:9}
    .tab{padding:14px;flex:1;text-align:center;font-weight:700;cursor:pointer;transition:.2s}
    .tab.active{background:var(--a);color:#000}
    .content{padding:15px;display:none}
    .content.active{display:block}
    #connectContainer{margin:15px 0}
    #addr{font-size:13px;color:var(--s);margin:10px 0;word-break:break-all}
    .btn{background:var(--a);color:#000;border:none;padding:16px;border-radius:28px;font-weight:800;font-size:17px;width:100%;margin:10px 0;cursor:pointer}
    #balance{font-size:36px;color:var(--a);font-weight:900}
    #timer{margin:10px 0 20px;color:var(--p);font-size:18px;font-weight:600}

    /* Chat & Feed */
    #messages, #feed{max-height:60vh;overflow-y:auto;padding:10px;background:#111;border-radius:16px}
    .msg{padding:10px;border-radius:12px;margin:8px 0;background:#1a1a1a;position:relative}
    .msg.me{background:var(--a);color:#000;margin-left:20%}
    .msg-name{font-weight:700;font-size:13px;color:var(--a)}
    .msg-text{margin-top:4px;word-break:break-all}
    .msg-time{font-size:11px;color:#666;float:right}
    #chatInput,#postInput{width:100%;padding:14px;background:#222;border:none;border-radius:50px;color:white;margin:10px 0}
    #sendBtn,#postBtn{background:var(--a);color:#000;border:none;padding:14px 20px;border-radius:50px;font-weight:800;cursor:pointer}
    footer{padding:15px;text-align:center;color:var(--s);font-size:13px}
  </style>
</head>
<body>
  <header>
    <img src="https://i.imgur.com/LQuakpq.png" alt="LockGram">
    <h1>LockGram Mini</h1>
    <p>Balance: <span id="balance">0</span> LC</p>
    <p id="timer">Connect wallet to farm</p>
  </header>

  <div class="tabs">
    <div class="tab active" onclick="openTab('farm')">Farm</div>
    <div class="tab" onclick="openTab('chat')">Chat</div>
    <div class="tab" onclick="openTab('journey')">Journey</div>
  </div>

  <!-- FARM TAB -->
  <div id="farm" class="content active">
    <div id="connectContainer"></div>
    <p id="addr"></p>
    <p id="status" style="color:var(--a);margin:15px 0">Connect wallet = +50 LC bonus</p>
    <button class="btn" onclick="invite()">Invite Friend (+10 LC)</button>
    <button class="btn" onclick="checkIn()">Daily Check-In (+5 LC)</button>
  </div>

  <!-- CHAT TAB -->
  <div id="chat" class="content">
    <div id="messages"></div>
    <input type="text" id="chatInput" placeholder="Say something in the farm..." maxlength="200">
    <button id="sendBtn">Send</button>
  </div>

  <!-- JOURNEY TAB -->
  <div id="journey" class="content">
    <div id="feed"></div>
    <textarea id="postInput" placeholder="Share your LockGram journey... (max 300 chars)" maxlength="300" rows="3"></textarea>
    <button id="postBtn">Post Journey</button>
  </div>

  <footer>Made with love â€¢ Stay locked = get rich</footer>

  <script>
    Telegram.WebApp.ready(); Telegram.WebApp.expand();
    const user = Telegram.WebApp.initDataUnsafe.user || {};
    let balance = 0, wallet = null, tonConnectUI = null, farming = null;

    // Load data
    balance = parseInt(localStorage.getItem('lockgram_balance') || '0');
    document.getElementById('balance').textContent = balance;

    // TON Connect
    function initTC() {
      if (!window.TON_CONNECT_UI) return setTimeout(initTC, 300);
      tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
        manifestUrl: 'https://meek-creponne-1338a7.netlify.app/manifest.json',
        buttonRootId: 'connectContainer'
      });
      tonConnectUI.onStatusChange(w => {
        wallet = w;
        if (w) {
          document.getElementById('addr').textContent = w.account.address.slice(0,6)+'...'+w.account.address.slice(-4);
          document.getElementById('status').textContent = 'Farming +1 LC/min';
          if (!localStorage.getItem('first_connect')) { addCoins(50); localStorage.setItem('first_connect','1'); }
          startFarming();
        } else {
          document.getElementById('status').textContent = 'Connect wallet to farm';
          stopFarming();
        }
      });
    }
    initTC();

    // Farming
    function startFarming() {
      if (farming) return;
      farming = setInterval(() => {
        if (document.visibilityState === 'visible' && wallet) {
          addCoins(1);
          document.getElementById('timer').textContent = 'Farming live +1 LC/min';
        }
      }, 60000);
    }
    function stopFarming() { clearInterval(farming); farming = null; }

    function addCoins(n) {
      balance += n;
      document.getElementById('balance').textContent = balance;
      localStorage.setItem('lockgram_balance', balance);
      Telegram.WebApp.HapticFeedback.impactOccurred('medium');
      if (n>1) postAuto(`just earned +\( {n} LC! Current: \){balance} LC`);
    }

    // Tabs
    function openTab(name) {
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
      document.querySelector(`.tab[onclick="openTab('${name}')"]`).classList.add('active');
      document.getElementById(name).classList.add('active');
      if (name === 'chat' || name === 'journey') loadMessages();
    }

    // Chat & Feed System
    function saveMessage(type, text) {
      const messages = JSON.parse(localStorage.getItem('lockgram_messages') || '[]');
      messages.push({
        id: Date.now(),
        type,
        name: user.first_name || 'Farmer',
        username: user.username ? '@'+user.username : '',
        text,
        time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
      });
      if (messages.length > 500) messages.shift();
      localStorage.setItem('lockgram_messages', JSON.stringify(messages));
    }

    function postAuto(text) {
      saveMessage('auto', text);
      if (document.getElementById('chat').classList.contains('active')) loadMessages();
    }

    function loadMessages() {
      const messages = JSON.parse(localStorage.getItem('lockgram_messages') || '[]');
      const chatDiv = document.getElementById('messages');
      const feedDiv = document.getElementById('feed');
      chatDiv.innerHTML = '';
      feedDiv.innerHTML = '';

      messages.forEach(m => {
        const div = document.createElement('div');
        div.className = 'msg';
        div.innerHTML = `
          <div class="msg-name">\( {m.name} \){m.username}</div>
          <div class="msg-text">${m.text}</div>
          <div class="msg-time">${m.time}</div>
        `;
        if (m.type === 'chat') chatDiv.appendChild(div);
        if (m.type === 'journey' || m.type === 'auto') feedDiv.appendChild(div.cloneNode(true));
      });
      chatDiv.scrollTop = chatDiv.scrollHeight;
      feedDiv.scrollTop = feedDiv.scrollHeight;
    }

    // Send chat
    document.getElementById('sendBtn').onclick = () => {
      const input = document.getElementById('chatInput');
      if (!input.value.trim()) return;
      saveMessage('chat', input.value);
      input.value = '';
      loadMessages();
    };

    // Post journey
    document.getElementById('postBtn').onclick = () => {
      const input = document.getElementById('postInput');
      if (!input.value.trim()) return;
      saveMessage('journey', input.value);
      input.value = '';
      Telegram.WebApp.showAlert('Journey posted!');
      loadMessages();
    };

    // Actions
    function invite() {
      if (!wallet) return Telegram.WebApp.showAlert('Connect wallet first!');
      const url = `https://t.me/Lockgramapp_bot/Lockgrammini?startapp=ref_${wallet.account.address.slice(-8)}`;
      Telegram.WebApp.openLink(url);
      addCoins(10);
    }
    function checkIn() {
      const today = new Date().toDateString();
      if (localStorage.getItem('checkin') === today) return Telegram.WebApp.showAlert('Already checked in!');
      localStorage.setItem('checkin', today);
      addCoins(5);
    }

    // Auto load messages when opening tabs
    setInterval(() => {
      if (document.querySelector('#chat.active') || document.querySelector('#journey.active')) loadMessages();
    }, 5000);

    // Warn when leaving
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') Telegram.WebApp.showAlert("Don't leave bro! Farming paused");
    });

    // Start farming if already connected
    setTimeout(() => wallet && startFarming(), 3000);
  </script>
</body>
</html>
